<!-- Faraday Penetration Test IDE -->
<!-- Copyright (C) 2013  Infobyte LLC (http://www.infobytesec.com/) -->
<!-- See the file 'doc/LICENSE' for the license information -->

<script type="text/javascript" src="script/compound.js"></script>
<script type="text/javascript">
function htmlentities(string, quote_style, charset, double_encode) {
    var hash_map = translationtable('HTML_ENTITIES', quote_style), symbol = '';
    string = string == null ? '' : string + '';

    if (!hash_map) {
        return false;
    }

    if (quote_style && quote_style === 'ENT_QUOTES') {
        hash_map["'"] = '&#039;';
    }

    if ( !! double_encode || double_encode == null) {
        for (symbol in hash_map) {
            if (hash_map.hasOwnProperty(symbol)) {
                string = string.split(symbol)
                    .join(hash_map[symbol]);
            }
        }
    } else {
        string = string.replace(/([\s\S]*?)(&(?:#\d+|#x[\da-f]+|[a-zA-Z][\da-z]*);|$)/g, function (ignore, text, entity) {
            for (symbol in hash_map) {
                if (hash_map.hasOwnProperty(symbol)) {
                    text = text.split(symbol)
                        .join(hash_map[symbol]);
                }
            }
            return text + entity;
        });
    }
    return string;
};

function translationtable(table, quote_style) {
    var entities = {},
        hash_map = {},
        decimal;
    var constMappingTable = {},
        constMappingQuoteStyle = {};
    var useTable = {},
        useQuoteStyle = {};

    // Translate arguments
    constMappingTable[0]        = 'HTML_SPECIALCHARS';
    constMappingTable[1]        = 'HTML_ENTITIES';
    constMappingQuoteStyle[0]   = 'ENT_NOQUOTES';
    constMappingQuoteStyle[2]   = 'ENT_COMPAT';
    constMappingQuoteStyle[3]   = 'ENT_QUOTES';

    useTable = !isNaN(table) ? constMappingTable[table] : table ? table.toUpperCase() : 'HTML_SPECIALCHARS';
    useQuoteStyle = !isNaN(quote_style) ? constMappingQuoteStyle[quote_style] : quote_style ? quote_style.toUpperCase() :
        'ENT_COMPAT';

    if (useTable !== 'HTML_SPECIALCHARS' && useTable !== 'HTML_ENTITIES') {
        throw new Error('Table: ' + useTable + ' not supported');
    }

    entities['38'] = '&amp;';
    if (useTable === 'HTML_ENTITIES') {
    entities['160'] = '&nbsp;';
    entities['161'] = '&iexcl;';
    entities['162'] = '&cent;';
    entities['163'] = '&pound;';
    entities['164'] = '&curren;';
    entities['165'] = '&yen;';
    entities['166'] = '&brvbar;';
    entities['167'] = '&sect;';
    entities['168'] = '&uml;';
    entities['169'] = '&copy;';
    entities['170'] = '&ordf;';
    entities['171'] = '&laquo;';
    entities['172'] = '&not;';
    entities['173'] = '&shy;';
    entities['174'] = '&reg;';
    entities['175'] = '&macr;';
    entities['176'] = '&deg;';
    entities['177'] = '&plusmn;';
    entities['178'] = '&sup2;';
    entities['179'] = '&sup3;';
    entities['180'] = '&acute;';
    entities['181'] = '&micro;';
    entities['182'] = '&para;';
    entities['183'] = '&middot;';
    entities['184'] = '&cedil;';
    entities['185'] = '&sup1;';
    entities['186'] = '&ordm;';
    entities['187'] = '&raquo;';
    entities['188'] = '&frac14;';
    entities['189'] = '&frac12;';
    entities['190'] = '&frac34;';
    entities['191'] = '&iquest;';
    entities['192'] = '&Agrave;';
    entities['193'] = '&Aacute;';
    entities['194'] = '&Acirc;';
    entities['195'] = '&Atilde;';
    entities['196'] = '&Auml;';
    entities['197'] = '&Aring;';
    entities['198'] = '&AElig;';
    entities['199'] = '&Ccedil;';
    entities['200'] = '&Egrave;';
    entities['201'] = '&Eacute;';
    entities['202'] = '&Ecirc;';
    entities['203'] = '&Euml;';
    entities['204'] = '&Igrave;';
    entities['205'] = '&Iacute;';
    entities['206'] = '&Icirc;';
    entities['207'] = '&Iuml;';
    entities['208'] = '&ETH;';
    entities['209'] = '&Ntilde;';
    entities['210'] = '&Ograve;';
    entities['211'] = '&Oacute;';
    entities['212'] = '&Ocirc;';
    entities['213'] = '&Otilde;';
    entities['214'] = '&Ouml;';
    entities['215'] = '&times;';
    entities['216'] = '&Oslash;';
    entities['217'] = '&Ugrave;';
    entities['218'] = '&Uacute;';
    entities['219'] = '&Ucirc;';
    entities['220'] = '&Uuml;';
    entities['221'] = '&Yacute;';
    entities['222'] = '&THORN;';
    entities['223'] = '&szlig;';
    entities['224'] = '&agrave;';
    entities['225'] = '&aacute;';
    entities['226'] = '&acirc;';
    entities['227'] = '&atilde;';
    entities['228'] = '&auml;';
    entities['229'] = '&aring;';
    entities['230'] = '&aelig;';
    entities['231'] = '&ccedil;';
    entities['232'] = '&egrave;';
    entities['233'] = '&eacute;';
    entities['234'] = '&ecirc;';
    entities['235'] = '&euml;';
    entities['236'] = '&igrave;';
    entities['237'] = '&iacute;';
    entities['238'] = '&icirc;';
    entities['239'] = '&iuml;';
    entities['240'] = '&eth;';
    entities['241'] = '&ntilde;';
    entities['242'] = '&ograve;';
    entities['243'] = '&oacute;';
    entities['244'] = '&ocirc;';
    entities['245'] = '&otilde;';
    entities['246'] = '&ouml;';
    entities['247'] = '&divide;';
    entities['248'] = '&oslash;';
    entities['249'] = '&ugrave;';
    entities['250'] = '&uacute;';
    entities['251'] = '&ucirc;';
    entities['252'] = '&uuml;';
    entities['253'] = '&yacute;';
    entities['254'] = '&thorn;';
    entities['255'] = '&yuml;';
    }

    if (useQuoteStyle !== 'ENT_NOQUOTES') {
        entities['34'] = '&quot;';
    }
    if (useQuoteStyle === 'ENT_QUOTES') {
        entities['39'] = '&#39;';
    }
    entities['60'] = '&lt;';
    entities['62'] = '&gt;';

    // ascii decimals to real symbols
    for (decimal in entities) {
        if (entities.hasOwnProperty(decimal)) {
            hash_map[String.fromCharCode(decimal)] = entities[decimal];
        }
    }

    return hash_map;
}
function get_report_div(workspace, view, design){
	function load_all_hosts() {
		var iurl	= "/" + workspace + "/_design/" + design + "/_view/byinterfacecount?group=true";
		var hurl	= "/" + workspace + "/_design/" + design + "/_view/hosts";
		var surl	= "/" + workspace + "/_design/" + design + "/_view/byservicecount?group=true";
		
		var hosts	= new Object();
		var interfaces	= new Object();
		var services	= new Object();

		hosts		= get_obj(hurl);
		interfaces	= get_obj(iurl, interfaces);
		services	= get_obj(surl, services);
		if(jQuery.isEmptyObject(hosts)){
            table = "<div class='col-lg-6'><article><section class=\"sin_padding\" id=\"hosts\">"+
                        "<header><h2>Hosts report "+
                        "<span class=\"glyphicon glyphicon-info-sign faraday-qtips\""+
                        "title=\"Shows current WS' executed commands\"></span>"+
                        "</h2></header>"+
                        "<div class=\"alert alert-info alert-dismissible\">"+
                        "<button type=\"button\" class=\"close\" data-dismiss=\"alert\">"+
                        "<span aria-hidden=\"true\">&times;</span>"+
                        "<span class=\"sr-only\">Close</span>"+
                        "</button>"+
                        "<p>No services found yet</p>"+
                        "</div>"+
                        "</div></section>";
        }else{
			var table = "<div class='col-lg-6'><article><section class='sin_padding' id='hosts'>"+
	                        "<header><h2>Hosts report "+
	                        "<span class=\"glyphicon glyphicon-info-sign faraday-qtips\" "+
	                        "title=\"All hosts, each one showing its service count and operating system. "+
	                        "By clicking on a host IP you can access a list with all of its services\"></span>"+
				"</h2></header>";
			table += "<table id=\"hosts-"+workspace+"\" class=\"tablesorter table table-striped\"><thead><tr>"+
					"<th>Host</th>"+
					"<th>Services</th>"+
					"<th>OS</th>"+
					"</tr></thead><tbody>";
			$.each(hosts, function(k, v){
				var hname = htmlentities(v.name);
				if(!services.hasOwnProperty(k)) {
					services[k] = 0;
				} else {
					hname = "<a href=\"host-"+k+"\" class=\"host\">"+hname+"</a>";
				}
				if(!interfaces.hasOwnProperty(k)) interfaces[k] = 0;
				var icon = "";
				if(v.os.toLowerCase().indexOf("windows") > -1) icon = "windows";
				if(v.os.toLowerCase().indexOf("cisco") > -1) icon = "cisco";
				if(v.os.toLowerCase().indexOf("router") > -1) icon = "router";
				if(v.os.toLowerCase().indexOf("osx") > -1) icon = "osx";
				if(v.os.toLowerCase().indexOf("linux") > -1
					|| v.os.toLowerCase().indexOf("unix") > -1) icon = "linux";
				var os = "";
				if(icon === "") {
					os = "<span class=\"fa fa-laptop faraday-qtips\" title="+v.os+"></span>";
				} else {
					os = "<img src=\"../././reports/images/"+icon+".png\" class=\"faraday-qtips\" title=\""+v.os+"\"/>";
				}
				table += "<tr id=\"host-"+k+"\">"+
					"<td>"+hname+"</td>"+
					"<td>"+services[k]+"</td>"+
					"<td>"+os+"</td></tr>";
			});
			table += "</tbody></table></article></section></div>";
		}
		return table;
	}

	function get_obj_filter(ws, design, view, key) {
		var db = new CouchDB(ws);
		var sview = design + "/" + view;
		if(typeof key === 'undefined') {
			var matches = db.view(sview);
		} else if($.isArray(key)) {
			var matches = db.view(sview, {keys: JSON.stringify(key)});
		} else {
			var matches = db.view(sview, {key: key});
		}
		return matches.rows;
	}

	function get_obj(ourl) {
		var ls = {};
		$.ajax({
			dataType: "json",
			url: ourl,
			async: false,
			success: function(data) {
				$.each(data.rows, function(n, obj){
					ls[obj.key] = obj.value;
				});	
			}
		});
		return ls;
	}

	var hosts = load_all_hosts();
	return hosts;
}
</script>
