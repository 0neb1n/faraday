<!-- Faraday Penetration Test IDE &#45; Community Version -->
<!-- Copyright (C) 2013  Infobyte LLC (http://www.infobytesec.com/) -->
<!-- See the file 'doc/LICENSE' for the license information -->
<!DOCTYPE html>   
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8"/>
    <!--[if IE]><![endif]-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>Status Report | Faraday</title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    <meta name="author" content=""/>

    <!-- !CSS -->
    <link rel="stylesheet" type="text/css" href="normalize.css" />
    <link rel="stylesheet" type="text/css" href="estilos.css" />
    <link rel="stylesheet" type="text/css" href="script/jquery.qtip.css" />
    <link rel="stylesheet" href="script/bootstrap.min.css">
    <link rel="stylesheet" href="script/bootstrap-theme.min.css">
    <link href="favicon.ico" rel="shortcut icon">
    <link href="favicon.ico" type="image/vnd.microsoft.icon" rel="icon" />
    <link href="images/site_preview.jpg" rel="image_src" />

    <script type="text/javascript" src="script/couch.js"></script>
    <script type="text/javascript" src="script/common.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.couch.js"></script>
    <script type="text/javascript" src="script/bootstrap.min.js"></script>
    <script type="text/javascript" src="script/angular.js"></script>
    <script type="text/javascript" src="script/angular-route.js"></script>
    <script type="text/javascript" src="script/csv-export.js"></script>
    <script type="text/javascript" src="script/jquery.qtip.js"></script>

    <style>
        .wrapper{width:auto;}
        header.head{position: fixed;width:100%;z-index:10000}
        aside{position: fixed;top:0px;height: 100%}
        .fila{width: 100%;padding:40px 0 0 90px}
        .seccion{width: 100%;padding: 0px}
        #merge, #delete{margin:5px;float:right;}
        .left-nav {
            position:fixed !important;
            position:absolute;
            top:50px;
            right:0;
            bottom:0;
            left:0;
        }
    </style>
</head>

<body ng-app="status-report">
    <div id="cont">
        <div class="wrapper">
            <header class="head">
                <a href="#" class="ws-dashboard"><img class="logo" src="images/logo-faraday.png" alt="Faraday home | WS Dashboard"/></a>
            </header>
            
            <section id="main" class="seccion clearfix">
                <aside class="left-nav">
                    <nav>
                        <ul>
                            <li>
                                <a href="/tuvieja.html" class="ws-dashboard" style="color: #ffffff !important" title="WS Dashboard">
                                    <img class="ws-dashboard" src="images/ico-graph.png" alt="WS Dashboard"/>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="status-report" style="color: #ffffff !important" title="Status Report">
                                    <h2><span class="glyphicon glyphicon-list" title="Status Report"></span></h2>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </aside>

            <div class="right-main" ng-view>
            </div>

            </section>
        </div><!--!/#wrapper -->
    </div><!--!/#container -->

    <script type="text/javascript">
        $.ajaxSetup({
            async: false
        });

        var statusReport = angular.module('status-report', ['ngRoute'])
            .controller('statusReportCtrl', 
                            ['$scope', '$route', '$routeParams', 'statusReportFact', 
                            function($scope, $route, $routeParams, statusReport) {
                var ws = $routeParams.wsId;
                $scope.vulns = statusReport.get(ws);
                $scope.sortField = 'date';
                $scope.reverse = true;
                $scope.workspace = ws;
            }])
            .factory('statusReportFact', ['vulnsFact', 'hostsFact', function(vulnsFact, hostsFact) {
                var statusReportFact = {};

                statusReportFact.get = function(ws) {
                    var vulns = vulnsFact.getVulns(ws);
                    var hosts = hostsFact.getHosts(ws);
                    vulns.forEach(function(element, index, array) {
                        element.target = hosts[element.parent].name;
                    });
                    return vulns;
                }
                return statusReportFact;
            }])
            .factory('vulnsFact', function() {
                var vulnsFact = {};

                vulnsFact.getVulns = function(ws) {
                    var vulns = [];
                    vulns_url = "/"+ ws +"/_design/vulns/_view/all";
                    // gets vulns json from couch
                    $.getJSON(vulns_url, function(data) {
                        $.each(data.rows, function(n, obj){
                                var d = new Date(0); 
                                d.setUTCSeconds(obj.value.date);
                                d = d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear();
                                var web = false;
                                if(obj.value.status.toLowerCase().indexOf("web") > -1) web = true;
                                vulns.push({
                                    "date": d, 
                                    "status": obj.value.status, 
                                    "name": obj.value.name, 
                                    "desc": obj.value.desc, 
                                    "severity": obj.value.severity,
                                    "web": web,
                                    "parent": obj.key.substring(0, obj.key.indexOf('.'))});
                        });
                    });
                    return vulns;
                }
                return vulnsFact;
            })
            .factory('hostsFact', function() {
                var hostsFact = {};

                hostsFact.getHosts = function(ws) {
                    hosts_url = "/"+ws+"/_design/hosts/_view/hosts";
                    var hosts = [];
                    //gets hosts json from couch
                    $.getJSON(hosts_url, function(data) {
                        $.each(data.rows, function(n, obj) {
                           hosts[obj.id] = {"name": obj.value.name, "os": obj.value.os, "owned": obj.value.owned};
                        }); 
                    });
                    return hosts;
                }
                return hostsFact;
            })
            .directive('ddCollapseText', ['$compile', function($compile) {
                return {
                    restrict: 'A',
                    replace: true,
                    link: function(scope, element, attrs) {

                        // start collapsed
                        scope.collapsed = false;

                        // create the function to toggle the collapse
                        scope.toggle = function() {
                            scope.collapsed = !scope.collapsed;
                        };

                        // get the value of the dd-collapse-text attribute
                        attrs.$observe('ddCollapseText', function(maxLength) {
                            // get the contents of the element
                            var text = element.text();

                            if (text.length > maxLength) {
                                // split the text in two parts, the first always showing
                                var firstPart = String(text).substring(0, maxLength);
                                var secondPart = String(text).substring(maxLength, text.length);

                                // create some new html elements to hold the separate info
                                var firstSpan = $compile('<span>' + firstPart + '</span>')(scope);
                                var secondSpan = $compile('<span ng-if="collapsed">' + secondPart + '</span>')(scope);
                                var moreIndicatorSpan = $compile('<span ng-if="!collapsed"> ...</span>')(scope);
                                var toggleButton = $compile('<span class="collapse-text-toggle" ng-click="toggle()"> <a href="">{{collapsed ? "less" : "more"}}</a></span>')(scope);

                                // remove the current contents of the element
                                // and add the new ones we created
                                element.empty();
                                element.append(firstSpan);
                                element.append(secondSpan);
                                element.append(moreIndicatorSpan);
                                element.append(toggleButton);
                            }
                        });
                    }
                };
            }]);
            statusReport.config(['$routeProvider', function($routeProvider) {
                $routeProvider.
                    when('/ws/:wsId', {
                        templateUrl: 'partials/status_report.html',
                        controller: 'statusReportCtrl'
                    }).
                    otherwise({
                        templateUrl: 'partials/status_report.html',
                        controller: 'statusReportCtrl'
                    });
            }]);
    </script>
<script type="text/javascript">
    $(document).ready(function() {
        $('table.csv-export').toCSV();

        var dom = location.href;
        var workspace = dom.split("#")[1].split("/")[2];
        $(document).on("click", "#refresh", function() {
            location.reload();
        });
        $(document).on("click", "a.ws-dashboard", function(e) {
            e.preventDefault();
            var url = "../././reports/index.html#" + workspace;
            window.location.href = url;
        });
        $(document).on("click", "img.ws-dashboard", function (e) {
            e.preventDefault();
            var url = "../././reports/index.html#" + workspace;
            window.location.href = url;
        });
        $(document).on("click", "a.status-report", function(e) {
            e.preventDefault();
            var url = "../././reports/status_report.html#/ws/" + workspace;
            window.location.href = url;
        });
        $(document).on("click", "#selectAll", function(){
            if($("#selectAll").is(':checked')) {  
                $("input[type=checkbox]").attr('checked', true);
            } else {
                $("input[type=checkbox]").attr('checked', false);
            }
        });
        $(document).on("click", "#delete", function(){
           $('input:checked').each(function(){
            var id = $(this)[0].name;
            if(this.checked){
                $(this).parents("tr").remove();
            }
           });
        });
        $(document).on("click", "#merge", function(){
           $('input:checked').each(function(){
            console.log($(this)[0].name);
           });
        });
    });
</script>
</body>
</html> 
