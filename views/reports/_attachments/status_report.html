<!-- Faraday Penetration Test IDE &#45; Community Version -->
<!-- Copyright (C) 2013  Infobyte LLC (http://www.infobytesec.com/) -->
<!-- See the file 'doc/LICENSE' for the license information -->
<!DOCTYPE html>   
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8"/>
    <!--[if IE]><![endif]-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>Status Report | Faraday</title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    <meta name="author" content=""/>

    <!-- !CSS -->
    <link rel="stylesheet" type="text/css" href="normalize.css" />
    <link rel="stylesheet" type="text/css" href="estilos.css" />
    <link rel="stylesheet" type="text/css" href="script/jquery.qtip.css" />
    <link rel="stylesheet" href="script/bootstrap.min.css">
    <link rel="stylesheet" href="script/bootstrap-theme.min.css">
    <link href="favicon.ico" rel="shortcut icon">
    <link href="favicon.ico" type="image/vnd.microsoft.icon" rel="icon" />
    <link href="images/site_preview.jpg" rel="image_src" />

    <script type="text/javascript" src="script/couch.js"></script>
    <script type="text/javascript" src="script/common.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.couch.js"></script>
    <script type="text/javascript" src="script/bootstrap.min.js"></script>
    <script type="text/javascript" src="script/angular.js"></script>
    <script type="text/javascript" src="script/angular-route.js"></script>
    <script type="text/javascript" src="script/angular-selection-model.js"></script>
    <script type="text/javascript" src="script/ui-bootstrap-tpls-0.11.2.min.js"></script>
    <script type="text/javascript" src="script/jquery.qtip.js"></script>
</head>

<body ng-app="status-report">
    <div id="cont">
        <div class="wrapper">
            <header class="head">
                <a href="#" class="ws-dashboard"><img class="logo" src="images/logo-faraday.png" alt="Faraday home | WS Dashboard"/></a>
            </header>
            
            <section id="main" class="seccion clearfix">
                <aside class="left-nav">
                    <nav>
                        <ul>
                            <li>
                                <a href="#" class="ws-dashboard" style="color: #ffffff !important" title="WS Dashboard">
                                    <img class="ws-dashboard" src="images/ico-graph.png" alt="WS Dashboard"/>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="status-report" style="color: #ffffff !important" title="Status Report">
                                    <h2><span class="glyphicon glyphicon-list" title="Status Report"></span></h2>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </aside>
            <div class="right-main" ng-view>
            </div>

            </section>
        </div><!--!/#wrapper -->
    </div><!--!/#container -->

    <script type="text/javascript">
        $.ajaxSetup({
            async: false
        });

        var statusReport = angular.module('status-report', ['ngRoute', 'selectionModel', 'ui.bootstrap'])
            .constant("BASEURL", (function() {
                var url = window.location.origin + "/";
                return url;
            })())
            .controller('statusReportCtrl', 
                            ['$scope', '$filter', '$route', '$routeParams', '$modal', 'statusReportFact', 
                            function($scope, $filter, $route, $routeParams, $modal, statusReport) {
                $scope.sortField = 'date';
                $scope.reverse = true;
                // current Workspace
                $scope.workspace = $routeParams.wsId;
                $scope.vulns = statusReport.get($scope.workspace);

                $scope.severities = [
                    "unclassified",
                    "info",
                    "low",
                    "med",
                    "high"
                ];

                // returns scope vulns as CSV obj
                $scope.toCSV = function() {
                    var content = "\"Date\", \"Web\", \"Status\", \"Severity\", "+
                        "\"Name\", \"Target\", \"Description\" \n";
                    
                    $scope.vulns.forEach(function(v) {
                        content += "\""+v.date+"\","+
                            " \""+v.web+"\","+
                            " \"Vulnerable\","+
                            " \""+v.severity+"\","+
                            " \""+v.name+"\","+
                            " \""+v.target+"\","+
                            " \""+v.desc.replace(/\n[ ]*\n/g, "").replace(/\"/g, "'") +"\""+
                            "\n";
                    });

                    var obj = {
                        "title":    "SR-" + $scope.workspace,
                        "content":  content
                    };
                    
                    return obj;
                };

                $scope.remove = function() {
                    var old = $scope.vulns;
                    $scope.vulns = [];

                    old.forEach(function(v) {
                        if(v.selected) {
                            statusReport.remove($scope.workspace, v);
                        } else {
                            $scope.vulns.push(v);
                        }
                    });
                };

                // Updates all vulns with selected == true
                $scope.update = function(vulns, severity, name, desc) {
                    $scope.vulns = [];
                    var mod = false;

                    if(typeof(severity) != "undefined") {
                        mod = true;
                        var valid = false;
                    
                        $scope.severities.forEach(function(s) {
                            if(severity == s) valid = true;
                        });
                        
                        if(!valid) severity = "unclassified";
                    }
                    
                    vulns.forEach(function(v) {
                        if(v.selected) {
                            if(mod) v.severity = severity;
                            if(typeof(name) != "undefined") v.name = name;
                            if(typeof(desc) != "undefined") v.desc = desc;
                    
                            statusReport.put($scope.workspace, v, function(rev) {
                                v.rev = rev;
                            });
                            v.selected = false;
                        }
                        $scope.vulns.push(v);
                    });
                };

                $scope.edit = function() {
                    var selected = false;

                    $scope.vulns.forEach(function(v) {
                        if(v.selected) selected = true;
                    });

                    if(selected) {
                        var modal = $modal.open({
                            templateUrl: 'partials/modal-edit.html',
                            controller: 'modalEditCtrl',
                            size: 'lg',
                            resolve: {
                                severities: function() {
                                    return $scope.severities;
                                },
                                vulns: function() {
                                    return $scope.vulns;
                                }
                            }
                        });

                        modal.result.then(function(data) {
                            $scope.update(data.vulns, data.severity, data.name, data.desc);
                        });
                    } else {
                        var modal = $modal.open({
                            templateUrl: 'partials/modal-ko.html',
                            controller: 'modalKoCtrl',
                            resolve: {
                                msg: function() {
                                    return 'At least one vulnerabilty must be selected in order to edit';
                                }
                            }
                        });
                    }
                };

                $scope.checkAll = function() {
                    if(!$scope.selectall) {
                        $scope.selectall = true;
                    } else {
                        $scope.selectall = false;
                    }

                    angular.forEach($filter('filter')($scope.vulns, $scope.query), function(v) {
                        v.selected = $scope.selectall;
                    });
                };

                $scope.severityOrder = function(vuln){
                    var sev = {};
                    $scope.severities.forEach(function(s, i, a) {
                        sev.s = i;
                    });
                    return sev[vuln.severity];
                }
            }])
            .controller('modalEditCtrl', function($scope, $modalInstance, severities, vulns) {
                $scope.severities = severities;
                $scope.vulns = vulns;

                $scope.isChecked = function(i) {
                    return i.selected;
                };

                $scope.ok = function() {
                    var res = {
                        "vulns":    $scope.vulns, 
                        "severity": $scope.severity, 
                        "name":     $scope.name, 
                        "desc":     $scope.desc
                    };
                    $modalInstance.close(res);
                };

                $scope.cancel = function() {
                    $modalInstance.dismiss('cancel');
                };

            })
            .controller('modalKoCtrl', function($scope, $modalInstance, msg) {
                $scope.msg = msg;

                $scope.ok = function() {
                    $modalInstance.close();
                };
            })
            .factory('statusReportFact', ['vulnsFact', 'hostsFact', function(vulnsFact, hostsFact) {
                var statusReportFact = {};

                statusReportFact.get = function(ws) {
                    var vulns = vulnsFact.get(ws);
                    var hosts = hostsFact.get(ws);
                    vulns.forEach(function(element, index, array) {
                        element.target = hosts[element.parent].name;
                    });
                    return vulns;
                }

                statusReportFact.put = function(ws, vuln, callback) {
                    vulnsFact.put(ws, vuln, callback);
                };

                statusReportFact.remove = function(ws, vuln) {
                    vulnsFact.remove(ws, vuln);
                }

                return statusReportFact;
            }])
            .factory('vulnsFact', ['BASEURL', '$http', function(BASEURL, $http) {
                var vulnsFact = {};

                vulnsFact.get = function(ws) {
                    var vulns = [];
                    vulns_url = BASEURL + ws +"/_design/vulns/_view/all";
                    // gets vulns json from couch
                    $.getJSON(vulns_url, function(data) {
                        $.each(data.rows, function(n, obj){
                            var d = new Date(0); 
                            d.setUTCSeconds(obj.value.date);
                            d = d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear();
                            var web = false;
                            if(obj.value.status.toLowerCase().indexOf("web") > -1) web = true;
                            var v = {
                                "id":           obj.id,
                                "rev":          obj.value.rev,
                                "desc":         obj.value.desc, 
                                "meta":         obj.value.meta,
                                "date":         d, 
                                "name":         obj.value.name, 
                                "oid":          obj.value.oid,
                                "owned":        obj.value.owned,
                                "owner":        obj.value.owner,
                                "parent":       obj.key.substring(0, obj.key.indexOf('.')),
                                "couch_parent": obj.value.parent,
                                "refs":         obj.value.refs,
                                "severity":     obj.value.severity,
                                "status":       obj.value.status, 
                                "web":          web,
                                "selected":     false,
                                "delete":       false
                            };
                            vulns.push(v);
                        });
                    });
                    return vulns;
                }

                vulnsFact.put = function(ws, vuln, callback) {
                    var url = BASEURL + ws + "/" + vuln.id;
                    var v = {
                        "_rev":         vuln.rev,
                        "desc":         vuln.desc, 
                        "metadata":     vuln.meta,
                        "name":         vuln.name, 
                        "obj_id":       vuln.oid,
                        "owned":        vuln.owned,
                        "owner":        vuln.owner,
                        "parent":       vuln.couch_parent, 
                        "refs":         vuln.refs,
                        "severity":     vuln.severity, 
                        "type":         vuln.status
                    };
                    $http.put(url, v).success(function(d, s, h, c) {
                        callback(d.rev);
                    });
                };

                vulnsFact.remove = function(ws, vuln) {
                    var url = BASEURL + ws + "/" + vuln.id + "?rev=" + vuln.rev;
                    $http.delete(url).success(function(d, s, h, c) {
                        console.log(d);
                    });
                };

                return vulnsFact;
            }])
            .factory('hostsFact', ['BASEURL', function(BASEURL) {
                var hostsFact = {};

                hostsFact.get = function(ws) {
                    hosts_url = BASEURL + ws + "/_design/hosts/_view/hosts";
                    var hosts = [];
                    //gets hosts json from couch
                    $.getJSON(hosts_url, function(data) {
                        $.each(data.rows, function(n, obj) {
                           hosts[obj.id] = {"name": obj.value.name, "os": obj.value.os, "owned": obj.value.owned};
                        }); 
                    });
                    return hosts;
                }
                return hostsFact;
            }])
            // CSV export
            .factory('$blob', function() {
              return {
                csvToURL: function(content) {
                  var blob;
                  blob = new Blob([content], {type: 'text/csv'});
                  return (window.URL || window.webkitURL).createObjectURL(blob);
                },
                sanitizeCSVName: function(name) {
                  if (/^[A-Za-z0-9]+\.csv$/.test(name)) {
                    return name;
                  }
                  if (/^[A-Za-z0-9]+/.test(name)) {
                    return name + ".csv";
                  }
                  throw new Error("Invalid title fo CSV file : " + name);
                },
                revoke: function(url) {
                  return (window.URL || window.webkitURL).revokeObjectURL(url);
                }
              };
            })
            // CSV export
            .factory('$click', function() {
              return {
                on: function(element) {
                  var e = document.createEvent("MouseEvent");
                  e.initMouseEvent("click", false, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                  element.dispatchEvent(e);
                }
              };
            })
            // CSV export
            .directive('downloadCsv', function($parse, $click, $blob, $log, $timeout) {
              return {
                compile: function($element, attr) {
                  var fn = $parse(attr.downloadCsv);
                   
                  return function(scope, element, attr) {
                     
                    element.on('click', function(event) {
                      var a_href, content, title, url, _ref;
                      _ref = fn(scope), content = _ref.content, title = _ref.title;
                       
                      if (!(content != null) && !(title != null)) {
                        $log.warn("Invalid content or title in download-csv : ", content, title);
                        return;
                      }
                       
                      title = $blob.sanitizeCSVName(title);
                      url = $blob.csvToURL(content);
                       
                      element.append("<a download=\"" + title + "\" href=\"" + url + "\"></a>");
                      a_href = element.find('a')[0];
                       
                      $click.on(a_href);
                      $timeout(function() {$blob.revoke(url);});
                       
                      element[0].removeChild(a_href);
                    });
                  };
                }
              };
            })
            .directive('textCollapse', ['$compile', function($compile) {
                return {
                    restrict: 'A',
                    replace: true,
                    link: function(scope, element, attrs) {
                        // start collapsed
                        scope.collapsed = false;

                        // create the function to toggle the collapse
                        scope.toggle = function() {
                            scope.collapsed = !scope.collapsed;
                        };

                        // wait for changes on the text
                        attrs.$observe('textCollapseText', function(text) {
                            // and get the maxLength
                            var maxLength = scope.$eval(attrs.textCollapseMaxLength);

                            if(text.length > maxLength) {
                                // split the text in two parts, the first always showing
                                var firstPart = String(text).substring(0, maxLength);
                                var secondPart = String(text).substring(maxLength, text.length);

                                // create some new html elements to hold the separate info
                                var firstSpan = $compile('<span>' + firstPart + '</span>')(scope);
                                var secondSpan = $compile('<span ng-if="collapsed">' + secondPart + '</span>')(scope);
                                var moreIndicatorSpan = $compile('<span ng-if="!collapsed">...</span>')(scope);
                                var toggleButton = $compile('<span selection-model-ignore class="collapse-text-toggle" ng-click="toggle()"> <a href="" selection-model-ignore>{{collapsed ? "less" : "more"}}</a></span>')(scope);

                                // remove the current contents of the element
                                // and add the new ones we created
                                element.empty();
                                element.append(firstSpan);
                                element.append(secondSpan);
                                element.append(moreIndicatorSpan);
                                element.append(toggleButton);
                            } else {
                                element.empty();
                                element.append(text);
                            }
                        });
                    }
                };
            }]);
            statusReport.config(['$routeProvider', function($routeProvider) {
                $routeProvider.
                    when('/ws/:wsId', {
                        templateUrl: 'partials/status_report.html',
                        controller: 'statusReportCtrl'
                    }).
                    otherwise({
                        templateUrl: 'partials/status_report.html',
                        controller: 'statusReportCtrl'
                    });
            }]);
    </script>
<script type="text/javascript">
    $(document).ready(function() {
        var dom = location.href;
        var workspace = dom.split("#")[1].split("/")[2];
        $(document).on("click", "#refresh", function() {
            location.reload();
        });
        $(document).on("click", "a.ws-dashboard", function(e) {
            e.preventDefault();
            var url = "../././reports/index.html#" + workspace;
            window.location.href = url;
        });
        $(document).on("click", "a.status-report", function(e) {
            e.preventDefault();
            var url = "../././reports/status_report.html#/ws/" + workspace;
            window.location.href = url;
        });
    });
</script>
</body>
</html> 
